<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gmair.drift.order">
    <resultMap id="orderVo" type="finley.gmair.model.drift.DriftOrder">
        <result property="orderId" column="order_id"></result>
        <result property="consumerId" column="consumer_id"></result>
        <result property="activityId" column="activity_id"></result>
        <result property="equipId" column="equip_id"></result>
        <result property="consignee" column="consignee"></result>
        <result property="phone" column="phone"></result>
        <result property="address" column="address"></result>
        <result property="expectedDate" column="expected_date"></result>
        <result property="intervalDate" column="interval_date"></result>
        <result property="province" column="province"></result>
        <result property="city" column="city"></result>
        <result property="district" column="district"></result>
        <result property="totalPrice" column="total_price"></result>
        <result property="realPay" column="real_pay"></result>
        <result property="excode" column="excode"></result>
        <result property="machineOrderNo" column="machine_orderNo"></result>
        <result property="description" column="description"></result>
        <result property="status" column="order_status"
                typeHandler="finley.gmair.mybatis.handler.DriftOrderStatusHandler"></result>
        <result property="blockFlag" column="block_flag"></result>
        <result property="createAt" column="create_time"></result>
        <collection property="list" select="queryDriftItem" column="order_id"></collection>
    </resultMap>

    <resultMap id="orderDashboardVo" type="finley.gmair.model.drift.DriftOrderPanel">
        <result property="expressNum" column="express_num"></result>
        <result property="expressStatus" column="express_status"></result>
        <result property="activityName" column="activity_name"></result>
        <result property="equipName" column="equip_name"></result>
        <result property="expressAddress" column="express_address"></result>
        <result property="quantity" column="quantity"></result>
        <result property="orderId" column="order_id"></result>
        <result property="consumerId" column="consumer_id"></result>
        <result property="activityId" column="activity_id"></result>
        <result property="equipId" column="equip_id"></result>
        <result property="consignee" column="consignee"></result>
        <result property="phone" column="phone"></result>
        <result property="address" column="address"></result>
        <result property="expectedDate" column="expected_date"></result>
        <result property="intervalDate" column="interval_date"></result>
        <result property="province" column="province"></result>
        <result property="city" column="city"></result>
        <result property="district" column="district"></result>
        <result property="totalPrice" column="total_price"></result>
        <result property="realPay" column="real_pay"></result>
        <result property="excode" column="excode"></result>
        <result property="machineOrderNo" column="machine_orderNo"></result>
        <result property="description" column="description"></result>
        <result property="status" column="order_status"
                typeHandler="finley.gmair.mybatis.handler.DriftOrderStatusHandler"></result>
        <result property="blockFlag" column="block_flag"></result>
        <result property="createTime" column="create_time"></result>
        <collection property="list" select="queryDriftItem" column="order_id"></collection>
    </resultMap>

    <resultMap id="orderItemVo" type="finley.gmair.model.drift.DriftOrderItem">
        <result property="itemId" column="item_id"></result>
        <result property="orderId" column="order_id"></result>
        <result property="itemName" column="item_name"></result>
        <result property="itemPrice" column="item_price"></result>
        <result property="totalPrice" column="total_price"></result>
        <result property="realPrice" column="real_price"></result>
        <result property="singleNum" column="single_num"></result>
        <result property="quantity" column="quantity"></result>
        <result property="exQuantity" column="ex_quantity"></result>
        <result property="text" column="text"></result>
        <result property="url" column="url"></result>
        <result property="blockFlag" column="block_flag"></result>
        <result property="createAt" column="create_time"></result>
    </resultMap>

    <select id="query" parameterType="java.util.Map" resultMap="orderVo">
        select order_id, activity_id, equip_id, consumer_id, consignee, phone, address, province, city, district,machine_orderNo,
        expected_date, interval_date, total_price, real_pay, excode, description, order_status, block_flag, create_time
        from gmair_drift.drift_order
        where 1 = 1
        <if test="orderId != null">
            AND order_id = #{orderId}
        </if>
        <if test="activityId != null">
            AND activity_id = #{activityId}
        </if>
        <if test="consumerId != null">
            AND consumer_id = #{consumerId}
        </if>
        <if test="phone != null">
            AND phone = #{phone}
        </if>
        <if test="cityName != null">
            AND (city like #{cityName}
            OR district like #{cityName})
        </if>
        <if test="provinceName != null">
            AND province like #{provinceName}
        </if>
        <if test="startTime != null">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null">
            <![CDATA[
                AND create_time <= #{endTime}
            ]]>
        </if>
        <if test="status != null">
            AND order_status = #{status}
        </if>
        <if test="machineOrderNo != null">
            AND machine_orderNo = #{machineOrderNo}
        </if>
        <if test="statusList != null">
            AND order_status IN
            <foreach collection="statusList" open="(" close=")" separator="," item="item">#{item}</foreach>
        </if>
        <if test="blockFlag != null">
            AND block_flag = #{blockFlag}
        </if>
        <if test="createDate != null">
            AND to_days(expected_date)= to_days(#{createDate})
        </if>
        <if test="consumerId != null">
            ORDER BY create_time ASC
        </if>
        <if test="consumerId == null">
            ORDER BY expected_date ASC
        </if>
    </select>

    <select id="querydashboard" parameterType="java.util.Map" resultMap="orderDashboardVo">
        select order_id, activity_name,activity_id, equip_name, equip_id,consumer_id, order_status,consignee, phone,province,address,city,district,express_address,total_price,real_pay,description,buy_machine,machine_orderNo,quantity,
        expected_date, interval_date,excode, block_flag,create_time,express_num,express_status
        from order_activity_equipment_item_view
        where 1 = 1
        <if test="orderId != null">
            AND order_id = #{orderId}
        </if>
        <if test="activityId != null">
            AND activity_id = #{activityId}
        </if>
        <if test="consumerId != null">
            AND consumer_id = #{consumerId}
        </if>
        <if test="phone != null">
            AND phone = #{phone}
        </if>
        <if test="consignee != null">
            AND consignee = #{consignee}
        </if>
        <if test="machineOrderNo != null">
            AND machine_orderNo = #{machineOrderNo}
        </if>
        <if test="status != null">
            AND order_status = #{status}
        </if>
        <if test="startTime != null">
            AND expected_date >= #{startTime}
        </if>
        <if test="endTime != null">
            <![CDATA[
                AND expected_date <= #{endTime}
            ]]>
        </if>
        <if test="blockFlag != null">
            AND block_flag = #{blockFlag}
        </if>
        ORDER BY expected_date ASC
    </select>

    <select id="queryDriftItem" parameterType="java.lang.String" resultMap="orderItemVo">
        SELECT
            item_id,
            order_id,
            item_name,
            single_num,
            item_price,
            quantity,
            ex_quantity,
            total_price,
            real_price,
            text,
            url,
            block_flag,
            create_time
        FROM gmair_drift.drift_order_item
        WHERE drift_order_item.order_id = #{order_id}
        ORDER BY item_name ASC
    </select>

    <insert id="insert" parameterType="finley.gmair.model.drift.DriftOrder" useGeneratedKeys="false">
        INSERT INTO gmair_drift.drift_order (order_id, consumer_id, activity_id, equip_id, consignee, phone, address, expected_date, interval_date, province, city, district, total_price, real_pay,
                                             excode, description, order_status, block_flag, create_time)
        VALUES (#{orderId}, #{consumerId}, #{activityId}, #{equipId}, #{consignee}, #{phone}, #{address},
                            #{expectedDate}, #{intervalDate}, #{province}, #{city}, #{district}, #{totalPrice},
                #{realPay},
                #{excode}, #{description},
                #{status, typeHandler=org.apache.ibatis.type.EnumOrdinalTypeHandler},
                #{blockFlag}, #{createAt})
    </insert>

    <update id="update" parameterType="finley.gmair.model.drift.DriftOrder">
        update gmair_drift.drift_order
        <set>
            <if test="consignee != null">
                consignee = #{consignee},
            </if>
            <if test="phone != null">
                phone = #{phone},
            </if>
            <if test="address != null">
                address = #{address},
            </if>
            <if test="province != null">
                province = #{province},
            </if>
            <if test="city != null">
                city = #{city},
            </if>
            <if test="district != null">
                district = #{district},
            </if>
            <if test="machineOrderNo != null">
                machine_orderNo = #{machineOrderNo},
            </if>
            <if test="excode != null">
                excode = #{excode},
            </if>
            <if test="status != null">
                order_status = #{status, typeHandler=org.apache.ibatis.type.EnumOrdinalTypeHandler},
            </if>
            <if test="realPay != null">
                real_pay = #{realPay},
            </if>
            order_id = #{orderId}
        </set>
        where order_id = #{orderId}
    </update>

    <delete id="delete" parameterType="java.lang.String">
        DELETE FROM gmair_drift.drift_order
        WHERE order_id = #{orderId}
    </delete>
</mapper>