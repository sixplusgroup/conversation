<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gmair.machine.prebind">
    <resultMap id="prebindVo" type="finley.gmair.model.machine.PreBindCode">
        <result property="bindId" column="bind_id"></result>
        <result property="machineId" column="machine_id"></result>
        <result property="codeValue" column="code_value"></result>
        <result property="blockFlag" column="block_flag"></result>
        <result property="createAt" column="create_time"></result>
    </resultMap>
    
    <select id="query" parameterType="java.util.Map" resultMap="prebindVo">
        SELECT bind_id, machine_id, code_value, block_flag, create_time
        FROM gmair_machine.pre_bind
        WHERE 1 = 1
        <if test="bindId != null">
            AND bind_id = #{bindId}
        </if>
        <if test="machineId != null">
            AND machine_id = #{machineId}
        </if>
        <if test="codeValue != null">
            AND code_value = #{codeValue}
        </if>
        <if test="blockFlag != null">
            AND block_flag = #{blockFlag}
        </if>
        <if test="startTime != null">
            AND DATE(create_time) >= #{startTime}
        </if>
        <if test="endTime != null">
            <![CDATA[
            AND DATE(create_time) <= #{endTime}
            ]]>
        </if>
        <if test="search != null">
            AND (machine_id LIKE #{search} OR code_value LIKE #{search})
        </if>
        ORDER BY create_time DESC 
    </select>

    <select id="queryByDate" parameterType="java.util.Map" resultMap="prebindVo">
        select bind_id, machine_id, code_value, block_flag, create_time
        from gmair_machine.pre_bind
        where 1 = 1
        <if test="bindId != null">
            AND bind_id = #{bindId}
        </if>
        <if test="machineId != null">
            AND machine_id = #{machineId}
        </if>
        <if test="codeValue != null">
            AND code_value = #{codeValue}
        </if>
        <if test="blockFlag != null">
            AND block_flag = #{blockFlag}
        </if>
        <if test="dateNow != null">
            AND date(create_time) = #{dateNow}
        </if>
        order by create_time desc
    </select>

    <insert id="insert" parameterType="finley.gmair.model.machine.PreBindCode" useGeneratedKeys="false">
        INSERT INTO gmair_machine.pre_bind(bind_id, machine_id, code_value, block_flag, create_time)
        VALUES(#{bindId}, #{machineId}, #{codeValue}, #{blockFlag}, #{createAt})
    </insert>

    <!--根据machine_id或者code_value查找prebind表-->
    <select id="queryBy2Id" parameterType="string" resultMap="prebindVo">
         SELECT bind_id, machine_id, code_value, block_flag, create_time
         FROM gmair_machine.pre_bind
         WHERE machine_id = #{machineId} OR code_value = #{codeValue}
    </select>

    <!--删除预绑定，更新idlemachine-->
    <update id="updateIdleMachine" parameterType="String">
        UPDATE gmair_machine.idle_machine SET block_flag = 0 WHERE machine_id =
        (SELECT machine_id FROM gmair_machine.pre_bind WHERE bind_id = #{bindId});
    </update>

    <!--根据qrcode删除相应预绑定-->
    <delete id="deletePrebind" parameterType="String">
        UPDATE gmair_machine.pre_bind
        <set>
            block_flag = true
        </set>
        WHERE bind_id = #{bindId};
    </delete>

</mapper>