<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gmair.machine.machine_filter_info">
    <resultMap id="machine_primary_filter_info" type="finley.gmair.dto.MachinePrimaryFilterInfo">
        <result property="qrcode" column="qr_code"/>
        <result property="needClean" column="is_need_clean"/>
        <result property="remindSwitchOn" column="clean_remind_status"/>
        <result property="isReminded" column="is_reminded"/>
        <result property="lastConfirmTime" column="last_confirm_time"/>
    </resultMap>

    <resultMap id="machine_efficient_filter_info" type="finley.gmair.dto.MachineEfficientFilterInfo">
        <result property="qrcode" column="qr_code"/>
        <result property="replaceStatus" column="replace_status"
                typeHandler="finley.gmair.mybatis.handler.EfficientFilterStatusHandler"/>
        <result property="remindSwitchOn" column="replace_remind_on"/>
        <result property="isRemindedStatus" column="is_reminded_status"
                typeHandler="finley.gmair.mybatis.handler.EfficientFilterRemindStatusHandler"/>
        <result property="lastConfirmTime" column="last_confirm_time"/>
    </resultMap>

    <select id="query_primary" parameterType="java.util.Map" resultMap="machine_primary_filter_info">
        SELECT m.qr_code, m.is_need_clean, m.clean_remind_status, m.is_reminded, m.last_confirm_time
        FROM gmair_machine.machine_filter_clean m, gmair_machine.goods_model g, gmair_machine.qrcode q
        WHERE m.qr_code = q.code_value AND q.model_id = g.model_id
        <if test="qrcode != null">
            AND m.qr_code = #{qrcode}
        </if>
        <if test="machineModelName != null">
            AND g.model_name = #{machineModelName}
        </if>
        <if test="machineModelCode != null">
            AND g.model_code = #{machineModelCode}
        </if>
        <if test="blockFlag != null">
            AND m.block_flag = #{blockFlag}
        </if>
        order by m.create_time desc LIMIT #{offset}, #{pageSize}
    </select>

    <select id="query_efficient" parameterType="java.util.Map" resultMap="machine_efficient_filter_info">
        SELECT m.qr_code, m.replace_status, m.replace_remind_on, m.is_reminded_status, me.last_confirm_time
        FROM gmair_machine.machine_efficient_filter m
        left join gmair_machine.machine_efficient_information me on m.qr_code = me.qr_code
        inner join gmair_machine.qrcode q on m.qr_code = q.code_value
        inner join gmair_machine.goods_model g on q.model_id = g.model_id
        where 1 = 1
        <if test="qrcode != null">
            AND m.qr_code = #{qrcode}
        </if>
        <if test="machineModelName != null">
            AND g.model_name = #{machineModelName}
        </if>
        <if test="machineModelCode != null">
            AND g.model_code = #{machineModelCode}
        </if>
        <if test="blockFlag != null">
            AND m.block_flag = #{blockFlag}
        </if>
        order by m.create_time desc LIMIT #{offset}, #{pageSize}
    </select>

    <select id="query_model_name" resultType="java.lang.String">
        SELECT distinct(model_name) FROM gmair_machine.goods_model where block_flag = 0
    </select>

    <select id="query_model_code" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT model_code FROM gmair_machine.goods_model where block_flag = 0
        <if test="_parameter != null">
            AND model_name = #{modelName}
        </if>
    </select>

</mapper>