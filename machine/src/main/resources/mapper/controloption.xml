<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gmair.machine.control.option">
    <resultMap id="controlOptionVo" type="finley.gmair.vo.machine.ControlOptionVo">
        <result property="controlId" column="option_id"></result>
        <result property="optionName" column="option_name"></result>
        <result property="optionComponent" column="option_component"></result>
        <result property="modelId" column="model_id"></result>
        <result property="blockFlag" column="block_flag"></result>
        <result property="createAt" column="create_time"></result>
        <collection property="actions" select="getActions" column="controlId = option_id,modelId = model_id"></collection>
    </resultMap>

    <resultMap id="controlOptionActionVo" type="finley.gmair.vo.machine.ControlOptionActionVo">
        <result property="valueId" column="value_id"></result>
        <result property="actionName" column="action_name"></result>
        <result property="actionOperator" column="action_operator"></result>
        <result property="commandValue" column="command_value"></result>
        <result property="blockFlag" column="block_flag"></result>
        <result property="createAt" column="create_time"></result>
    </resultMap>
    
    <select id="getActions" resultMap="controlOptionActionVo">
        SELECT value_id, action_name, action_operator
        FROM gmair_machine.control_option_action
        WHERE control_id = #{controlId} AND model_id=#{modelId} AND block_flag = 0
    </select>

    <insert id="insert" parameterType="finley.gmair.model.machine.ControlOption">
        INSERT INTO gmair_machine.control_option(option_id, option_name, option_component, block_flag, create_time)
        VALUES(#{controlId}, #{optionName}, #{optionComponent}, #{blockFlag}, #{createAt})
    </insert>

    <select id="query" resultMap="controlOptionVo" parameterType="java.util.Map">
        SELECT option_id, option_name, option_component, block_flag, create_time
        FROM gmair_machine.control_option
        WHERE 1 = 1
        <if test="controlId != null">
            AND option_id = #{controlId}
        </if>
        <if test="optionName != null">
            AND option_name = #{optionName}
        </if>
        <if test="optionComponent != null">
            AND option_component = #{optionComponent}
        </if>
        <if test="blockFlag != null">
            AND block_flag = #{blockFlag}
        </if>
        ORDER BY create_time DESC
    </select>

    <select id="queryAction" parameterType="java.util.Map" resultMap="controlOptionActionVo">
        SELECT value_id, action_name, action_operator, command_value, block_flag, create_time
        FROM gmair_machine.control_option_action
        WHERE 1 = 1
        <if test="valueId != null">
            AND value_id = #{valueId}
        </if>
        <if test="controlId != null">
            AND control_id = #{controlId}
        </if>
        <if test="modelId != null">
            AND model_id = #{modelId}
        </if>
        <if test="actionName != null">
            AND action_name = #{actionName}
        </if>
        <if test="actionOperator != null">
            AND action_operator = #{actionOperator}
        </if>
        <if test="blockFlag != null">
            AND block_flag = #{blockFlag}
        </if>
        ORDER BY create_time DESC
    </select>

    <insert id="insertAction" parameterType="finley.gmair.model.machine.ControlOptionAction">
        INSERT INTO gmair_machine.control_option_action(value_id, control_id, model_id, action_name, action_operator,command_value, block_flag, create_time)
        VALUES(#{valueId}, #{controlId}, #{modelId}, #{actionName}, #{actionOperator},#{commandValue}, #{blockFlag}, #{createAt})
    </insert>

    <!-- 2018.07.17 wjq add -->
    <select id="queryByModelId" parameterType="java.util.Map" resultMap="controlOptionVo">
        SELECT co.option_id,co.option_name,co.option_component,coa.model_id,co.block_flag,co.create_time
        FROM gmair_machine.control_option_action AS coa, gmair_machine.control_option AS co
        WHERE co.option_id = coa.control_id AND coa.model_id = #{modelId} AND co.block_flag = 0 AND coa.block_flag = 0
        GROUP BY co.option_id
    </select>
</mapper>